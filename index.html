<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบวิเคราะห์ ABC อะไหล่ (เวอร์ชันสวยสุด)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Prompt", "Segoe UI", sans-serif; margin: 0; background: #f5f7fa; padding: 10px; }
        .container { max-width: 1920px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        h1 { text-align: center; color: white; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); font-size: 26px; margin: 0; }
        .subtitle { text-align: center; color: #888; font-size: 15px; padding: 10px 0; background: #f8f9fa; margin: 0; }

        /* Summary Cards - Responsive Flex Layout */
        .summary-row { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; padding: 16px; background: #f8f9fa; }
        .card { flex: 1 1 140px; min-width: 140px; max-width: 180px; padding: 12px; border-radius: 14px; text-align: center; color: white; cursor: pointer; transition: all 0.3s; box-shadow: 0 6px 15px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.2); }
        .card:hover { transform: translateY(-6px); }
        .card-title { font-size: 12px; opacity: 0.95; margin-bottom: 6px; }
        .card-value { font-size: 20px; font-weight: 900; margin: 6px 0; }
        .card-count { font-size: 11px; background: rgba(0,0,0,0.3); border-radius: 6px; padding: 3px 8px; }
        .total-stock { background: linear-gradient(135deg, #2c3e50, #34495e); }
        .order-items { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .return-value { background: linear-gradient(135deg, #e67e22, #d35400); }
        .monthly-withdrawal { background: linear-gradient(135deg, #8e44ad, #9b59b6); }
        .stock-days { background: linear-gradient(135deg, #3498db, #2980b9); }
        .after-stock-days { background: linear-gradient(135deg, #2ecc71, #27ae60); }
        .abc-a { background: linear-gradient(135deg, #ff7675, #ff4757); }
        .abc-b { background: linear-gradient(135deg, #ffeaa7, #ffd32a); }
        .abc-c { background: linear-gradient(135deg, #a3daff, #74b9ff); }
        .fast { background: linear-gradient(135deg, #55efc4, #00b894); }
        .medium { background: linear-gradient(135deg, #ffeaa7, #fdcb6e); }
        .slow { background: linear-gradient(135deg, #fab1a0, #e17055); }
        .slowly { background: linear-gradient(135deg, #dfe6e9, #b2bec3); }
        .dead { background: linear-gradient(135deg, #b2bec3, #636e72); }

        /* Controls - Canva-inspired Styling: Vibrant, Clean, Icons */
        .controls { padding: 20px; background: #fff; display: flex; flex-direction: column; gap: 15px; justify-content: flex-start; border-bottom: 1px solid #eee; align-items: flex-start; }
        .filter-row { display: flex; gap: 15px; align-items: center; }
        .search-row { display: flex; gap: 15px; align-items: center; width: 100%; }
        .control-group { display: flex; align-items: center; gap: 10px; background: linear-gradient(135deg, #f0f4ff, #e0eaff); padding: 12px 20px; border-radius: 16px; font-size: 14px; box-shadow: 0 4px 10px rgba(102, 126, 234, 0.1); transition: all 0.3s; }
        .control-group:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(102, 126, 234, 0.2); }
        .control-icon { font-size: 18px; color: #667eea; }
        label { font-weight: 600; color: #2c3e50; display: flex; align-items: center; gap: 5px; }
        select, input[type=number], input[type=text] { padding: 10px 14px; border-radius: 10px; border: 1px solid #ccd1ff; font-size: 14px; background: white; transition: border 0.2s; width: 80px; }
        select { width: 120px; }
        input[type=text] { width: 250px; }
        select:focus, input[type=number]:focus, input[type=text]:focus { border-color: #667eea; outline: none; }
        .unit { font-size: 14px; color: #667eea; font-weight: 500; }
        .export-btn { padding: 12px; background: linear-gradient(135deg, #27ae60, #1e8449); color: white; border: none; border-radius: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; box-shadow: 0 6px 15px rgba(39,174,96,0.4); transition: all 0.3s; flex: 0 1 auto; margin-left: auto; }

        /* ตารางใหม่: Responsive Table with Scroll on Small Screens, Canva-like Styling */
        .table-container { overflow: auto; max-height: 70vh; position: relative; padding: 0 16px; }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; /* Minimum width for large tables */ border-radius: 12px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.1); background: white; }
        thead { position: sticky; top: 0; z-index: 10; background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        th { padding: 14px 10px; text-align: left; font-size: 13px; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        th:hover { background: rgba(255,255,255,0.1); }
        .sort-icon { margin-left: 4px; font-size: 10px; }
        tbody tr { transition: background 0.2s; border-bottom: 1px solid #eee; }
        tbody tr:hover { background: #f0f8ff; }
        tbody tr:nth-child(even) { background: #f8f9fa; }
        td { padding: 12px 10px; font-size: 13px; text-align: left; }
        .value { background: #667eea; color: white; padding: 4px 8px; border-radius: 8px; font-weight: bold; font-size: 12px; display: inline-block; }
        .order-0 { color: #95a5a6; }
        .order-1-10 { background: #d5f5e3; color: #1e8449; padding: 4px 8px; border-radius: 6px; display: inline-block; }
        .order-11-50 { background: #fef9e7; color: #d35400; padding: 4px 8px; border-radius: 6px; display: inline-block; }
        .order-51-200 { background: #fdecea; color: #c0392b; padding: 4px 8px; border-radius: 6px; display: inline-block; }
        .order-200 { background: #fadbd8; color: #c0392b; padding: 4px 8px; border-radius: 6px; font-weight: bold; display: inline-block; }
        .moving-fast, .moving-medium, .moving-slow, .moving-slowly, .moving-dead { padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; display: inline-block; }
        .moving-fast { background: #d5f5e3; color: #1e8449; }
        .moving-medium { background: #fef9e7; color: #d35400; }
        .moving-slow { background: #fdecea; color: #c0392b; }
        .moving-slowly { background: #f2f3f4; color: #616161; }
        .moving-dead { background: #f0f0f0; color: #7f8c8d; }
        .return-qty { background: #e74c3c; color: white; padding: 4px 8px; border-radius: 6px; display: inline-block; font-weight: bold; }

        /* Center Numeric Columns */
        th:nth-child(5), td:nth-child(5),
        th:nth-child(6), td:nth-child(6),
        th:nth-child(7), td:nth-child(7),
        th:nth-child(8), td:nth-child(8),
        th:nth-child(9), td:nth-child(9),
        th:nth-child(10), td:nth-child(10),
        th:nth-child(11), td:nth-child(11),
        th:nth-child(12), td:nth-child(12),
        th:nth-child(13), td:nth-child(13),
        th:nth-child(14), td:nth-child(14),
        th:nth-child(16), td:nth-child(16),
        th:nth-child(20), td:nth-child(20),
        th:nth-child(21), td:nth-child(21) { text-align: center; }

        /* Pagination - Centered and Responsive */
        .pagination { padding: 16px; text-align: center; background: #f8f9fa; font-size: 16px; font-weight: bold; color: #2c3e50; display: flex; justify-content: center; gap: 4px; flex-wrap: wrap; }
        .page-btn { padding: 8px 14px; background: white; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .page-btn.active { background: #667eea; color: white; border: none; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-btn:hover:not(.active):not(:disabled) { background: #e9ecef; }

        /* Media Query for Smaller Screens */
        @media (max-width: 768px) {
            .summary-row { gap: 8px; padding: 8px; }
            .card { flex: 1 1 120px; min-width: 120px; padding: 10px; }
            .card-value { font-size: 18px; }
            .control-group { flex-basis: 100%; max-width: none; }
            .controls { gap: 10px; }
            table { min-width: 100%; }
            th, td { padding: 8px 5px; font-size: 12px; }
            .pagination { font-size: 14px; }
        }

        /* Login Modal Styles */
        #loginModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .login-form { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: center; width: 300px; }
        .login-form input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccd1ff; border-radius: 10px; }
        .login-form button { padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; cursor: pointer; width: 100%; }
        .login-form label { display: flex; align-items: center; justify-content: center; gap: 5px; margin: 10px 0; }
        #loginError { color: red; margin-top: 10px; }

        /* Menu Button and Dropdown */
        #menuBtn { position: absolute; top: 20px; right: 20px; background: none; border: none; font-size: 24px; color: white; cursor: pointer; }
        #userMenu { position: absolute; top: 50px; right: 20px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: none; text-align: left; }
        #userMenu p { margin: 5px 0; }
        #logoutBtn { padding: 8px; background: #e74c3c; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; }

        /* Help Modal Styles */
        #helpModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .help-content { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); text-align: left; width: 600px; max-height: 80vh; overflow-y: auto; }
        .help-content h2 { text-align: center; }
        .help-content button { padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; border-radius: 10px; cursor: pointer; width: 100%; margin-top: 20px; }
        #helpBtn { padding: 8px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 10px; }

        /* Loader */
        .loader {
          --w:10ch;
          font-weight: bold;
          font-family: monospace;
          font-size: 30px;
          letter-spacing: var(--w);
          width:var(--w);
          overflow: hidden;
          white-space: nowrap;
          text-shadow:
            calc(-1*var(--w)) 0,
            calc(-2*var(--w)) 0,
            calc(-3*var(--w)) 0,
            calc(-4*var(--w)) 0,
            calc(-5*var(--w)) 0,
            calc(-6*var(--w)) 0,
            calc(-7*var(--w)) 0,
            calc(-8*var(--w)) 0,
            calc(-9*var(--w)) 0;
          animation: l16 2s infinite;
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          z-index: 1000;
        }
        .loader:before {
          content:"Loading...";
        }
        @keyframes l16 {
          20% {text-shadow:
            calc(-1*var(--w)) 0,
            calc(-2*var(--w)) 0 red,
            calc(-3*var(--w)) 0,
            calc(-4*var(--w)) 0 #ffa516,
            calc(-5*var(--w)) 0 #63fff4,
            calc(-6*var(--w)) 0,
            calc(-7*var(--w)) 0,
            calc(-8*var(--w)) 0 green,
            calc(-9*var(--w)) 0;}
          40% {text-shadow:
            calc(-1*var(--w)) 0,
            calc(-2*var(--w)) 0 red,
            calc(-3*var(--w)) 0 #e945e9,
            calc(-4*var(--w)) 0,
            calc(-5*var(--w)) 0 green,
            calc(-6*var(--w)) 0 orange,
            calc(-7*var(--w)) 0,
            calc(-8*var(--w)) 0 green,
            calc(-9*var(--w)) 0;}
          60% {text-shadow:
            calc(-1*var(--w)) 0 lightblue,
            calc(-2*var(--w)) 0,
            calc(-3*var(--w)) 0 #e945e9,
            calc(-4*var(--w)) 0,
            calc(-5*var(--w)) 0 green,
            calc(-6*var(--w)) 0,
            calc(-7*var(--w)) 0 yellow,
            calc(-8*var(--w)) 0 #ffa516,
            calc(-9*var(--w)) 0 red;}
          80% {text-shadow:
            calc(-1*var(--w)) 0 lightblue,
            calc(-2*var(--w)) 0 yellow,
            calc(-3*var(--w)) 0 #63fff4,
            calc(-4*var(--w)) 0 #ffa516,
            calc(-5*var(--w)) 0 red,
            calc(-6*var(--w)) 0,
            calc(-7*var(--w)) 0 grey,
            calc(-8*var(--w)) 0 #63fff4,
            calc(-9*var(--w)) 0 ;}
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ABC Analysis & Smart Ordering System</h1>
    <button id="menuBtn" style="display: none;"><i class="fas fa-user-circle"></i></button>
    <div id="userMenu">
        <p id="userID"></p>
        <p id="userName"></p>
        <button id="helpBtn">Help</button>
        <button id="logoutBtn">Log out</button>
    </div>
    <div class="loader" id="loader" style="display: none;"></div>
    <!-- Card เงินสั้น ๆ -->
    <div class="summary-row" id="mainCardsSection" style="display:none;">
        <div class="card total-stock" id="cardTotalStock">
            <div class="card-title">มูลค่ารวม</div>
            <div class="card-value" id="totalStockValue">0.00</div>
            <div class="card-count" id="totalCount">0 รายการ</div>
        </div>
        <div class="card order-items" id="cardOrderItems">
            <div class="card-title">Order</div>
            <div class="card-value" id="orderItemCount">0 </div>
            <div class="card-value" id="orderTotalValue">0.00</div>
        </div>
        <div class="card return-value" id="cardReturnValue">
            <div class="card-title">OverStock</div>
            <div class="card-value" id="returnValue">0.00</div>
            <div class="card-count" id="returnItemCount">0 รายการ</div>
        </div>
        <div class="card monthly-withdrawal" id="cardMonthlyWithdrawal">
            <div class="card-title">เบิก/เดือน</div>
            <div class="card-value" id="monthlyWithdrawalValue">0.00</div>
        </div>
        <div class="card stock-days" id="cardStockDays">
            <div class="card-title">Stock Days</div>
            <div class="card-value" id="stockDaysValue">0</div>
        </div>
        <div class="card after-stock-days" id="cardAfterStockDays">
            <div class="card-title">After Stock Days</div>
            <div class="card-value" id="afterStockDaysValue">0</div>
        </div>
    </div>
    <!-- ABC + Moving -->
    <div class="summary-row" id="summarySection" style="display:none;">
        <div class="card abc-a" id="abcA"><div class="card-title">กลุ่ม A</div><div class="card-value" id="sumA">0.00</div><div class="card-count" id="countA">0 รายการ</div></div>
        <div class="card abc-b" id="abcB"><div class="card-title">กลุ่ม B</div><div class="card-value" id="sumB">0.00</div><div class="card-count" id="countB">0 รายการ</div></div>
        <div class="card abc-c" id="abcC"><div class="card-title">กลุ่ม C</div><div class="card-value" id="sumC">0.00</div><div class="card-count" id="countC">0 รายการ</div></div>
        <div class="card fast" id="cardFast"><div class="card-title">Fast Moving</div><div class="card-value" id="valFast">0.00</div><div class="card-count" id="countFast">0 รายการ</div></div>
        <div class="card medium" id="cardMedium"><div class="card-title">Medium</div><div class="card-value" id="valMedium">0.00</div><div class="card-count" id="countMedium">0 รายการ</div></div>
        <div class="card slow" id="cardSlow"><div class="card-title">Slow Moving</div><div class="card-value" id="valSlow">0.00</div><div class="card-count" id="countSlow">0 รายการ</div></div>
        <div class="card slowly" id="cardSlowly"><div class="card-title">Slowly Moving</div><div class="card-value" id="valSlowly">0.00</div><div class="card-count" id="countSlowly">0 รายการ</div></div>
        <div class="card dead" id="cardDead"><div class="card-title">Dead Stock</div><div class="card-value" id="valDead">0.00</div><div class="card-count" id="countDead">0 รายการ</div></div>
    </div>
    <div class="controls" id="controlsSection" style="display:none;">
        <div class="filter-row">
            <div class="control-group">
                <label><i class="fas fa-industry control-icon"></i> Plant:</label>
                <select id="plantFilter"><option value="">ทุก Plant</option></select>
            </div>
            <div class="control-group">
                <label><i class="fas fa-clock control-icon"></i> Lead Time:</label>
                <input type="number" id="leadTimeDays" value="15">
                <span class="unit">วัน</span>
            </div>
            <div class="control-group">
                <label><i class="fas fa-shield-alt control-icon"></i> Safety:</label>
                <input type="number" id="safetyDays" value="5">
                <span class="unit">วัน</span>
            </div>
            <div class="control-group">
                <label><i class="fas fa-calendar-check control-icon"></i> ครอบคลุม:</label>
                <input type="number" id="coverDays" value="35">
                <span class="unit">วัน</span>
            </div>
        </div>
        <div class="search-row">
            <div class="control-group">
                <label><i class="fas fa-search control-icon"></i> ค้นหา:</label>
                <input type="text" id="searchInput" placeholder="Material หรือ Description">
            </div>
            <button class="export-btn" id="exportBtn"><i class="fas fa-file-export"></i></button>
        </div>
    </div>
    <div class="table-container" id="tableSection" style="display:none;">
        <table id="dataTable">
            <thead>
                <tr id="tableHeader">
                    <th data-sort="Plant">Plant <i class="fas fa-sort sort-icon"></i></th>
                    <th data-sort="Material">Material <i class="fas fa-sort sort-icon"></i></th>
                    <th>รายการอะไหล่</th>
                    <th data-sort="Unit">หน่วย</th>
                    <th data-sort="Unrestricted" title="จำนวนอะไหล่คงเหลือในคลัง">คงเหลือ <i class="fas fa-sort sort-icon"></i></th>
                    <th data-sort="Value" title="มูลค่าคงเหลือ = คงเหลือ * ราคาต่อหน่วย">มูลค่า <i class="fas fa-sort sort-icon"></i></th>
                    <th data-sort="Qty6Month" title="จำนวนเบิกออกใน 6 เดือนที่ผ่านมา">6M</th>
                    <th data-sort="Qty4Month" title="จำนวนเบิกออกใน 4 เดือนที่ผ่านมา">4M</th>
                    <th data-sort="AvgMonthly" title="เฉลี่ยต่อวัน = เบิก 4ด. / 120">AvgM</th>
                    <th data-sort="ThirtyDay" title="จำนวนเบิกใน 30 วันล่าสุด">30Day</th>
                    <th data-sort="Mean" title="ค่ามากสุดระหว่างเฉลี่ย/เดือน เดิม และ 30Day ">Mean</th>
                    <th data-sort="SafetyStock" title="Safety Stock = เฉลี่ยต่อวัน * จำนวนวัน Safety (เฉลี่ยต่อวัน = เฉลี่ยต่อเดือน / 30)">Safety</th>
                    <th data-sort="ROP" title="Reorder Point = (เฉลี่ยต่อวัน * Lead Time) + Safety Stock">ROP <i class="fas fa-sort sort-icon"></i></th>
                    <th data-sort="DOS" title="Days of Supply = คงเหลือ / เฉลี่ยต่อวัน (มากกว่า 9999 แสดง 'มาก')">DOS</th>
                    <th data-sort="RecommendedOrder" title="ถ้าคงเหลือ < ROP, แนะนำสั่ง = (เฉลี่ยต่อวัน * ครอบคลุมวัน) - คงเหลือ แล้วปรับตาม Package Size">แนะนำสั่ง <i class="fas fa-sort sort-icon"></i></th>
                    <th>หมายเหตุ</th>
                    <th data-sort="MultiplyUnit" title="ขนาดแพ็คเกจสำหรับการสั่งซื้อ (ใช้ในการปัดเศษแนะนำสั่ง)">Package</th>
                    <th data-sort="Product">Product</th>
                    <th data-sort="ABCValue" title="A: มูลค่าสะสม <= 70%, B: <= 90%, C: ที่เหลือ (เรียงจากมูลค่าสูงไปต่ำ)">ABC</th>
                    <th data-sort="Moving" title="Fast: >=30/เดือน, Medium: >=12, Slow: >=0.7, Slowly: <0.7, Dead: =0">Moving</th>
                    <th data-sort="ReturnQty" title="จำนวนส่งคืน = max(0, คงเหลือ - Keep Qty), Keep Qty ขึ้นกับ Moving และ ABC">จำนวนส่งคืน</th>
                    <th data-sort="CumPercent" title="% มูลค่าสะสมจากมูลค่ารวม (เรียงจากสูงไปต่ำ)">%สะสม <i class="fas fa-sort sort-icon"></i></th>
                </tr>
            </thead>
            <tbody id="dataList"></tbody>
        </table>
    </div>
    <div class="pagination" id="pagination" style="display:none;"></div>
</div>
<!-- Login Modal -->
<div id="loginModal" style="display: none;">
    <div class="login-form">
        <h2>Login</h2>
        <input type="text" id="idUserInput" placeholder="IDUser">
        <input type="password" id="passwordInput" placeholder="Password">
        <label><input type="checkbox" id="rememberMe"> จดจำฉัน</label>
        <button id="loginBtn">เข้าสู่ระบบ</button>
        <div id="loginError"></div>
    </div>
</div>
<!-- Help Modal -->
<div id="helpModal" style="display: none;">
    <div class="help-content">
        <h2>คู่มือการใช้งานระบบ ABC Analysis & Smart Ordering System</h2>
        <p><strong>เกี่ยวกับระบบ:</strong> ระบบนี้เป็นเครื่องมือวิเคราะห์อะไหล่ด้วยวิธี ABC Analysis และระบบแนะนำการสั่งซื้ออัจฉริยะ ช่วยในการจัดการสต็อกอะไหล่ให้มีประสิทธิภาพ โดยคำนวณจากข้อมูลการเบิกใช้งาน มูลค่าคงเหลือ และปัจจัยอื่นๆ เพื่อลดต้นทุนและป้องกันสต็อกเกิน</p>
        
        <h3>ฟังก์ชันหลักและวิธีใช้งาน:</h3>
        
        <p><strong>1. การเข้าสู่ระบบ (Login):</strong><br>
        - ป้อน IDUser และ Password (ใช้ 4 ตัวท้ายของ IDUser เป็น Password)<br>
        - เลือก "จดจำฉัน" เพื่อเข้าสู่ระบบอัตโนมัติครั้งถัดไป<br>
        - กด "เข้าสู่ระบบ" เพื่อเข้าใช้งาน</p>
        
        <p><strong>2. เมนูผู้ใช้ (User Menu):</strong><br>
        - กดไอคอนผู้ใช้ที่มุมขวาบนเพื่อเปิดเมนู<br>
        - แสดงรหัสและชื่อผู้ใช้<br>
        - กด "Help" เพื่อเปิดคู่มือนี้<br>
        - กด "Log out" เพื่อออกจากระบบ</p>
        
        <p><strong>3. การ์ดสรุป (Summary Cards):</strong><br>
        - แสดงข้อมูลสรุป เช่น มูลค่ารวม, Order, OverStock, เบิก/เดือน, Stock Days, After Stock Days<br>
        - กดการ์ดเพื่อกรองข้อมูล เช่น กด "Order" เพื่อแสดงเฉพาะรายการที่แนะนำสั่งซื้อ<br>
        - การ์ด ABC (A, B, C) และ Moving (Fast, Medium, Slow, Slowly, Dead) สำหรับกรองกลุ่มอะไหล่</p>
        
        <p><strong>4. ตัวควบคุม (Controls):</strong><br>
        - Plant: เลือก Plant เพื่อกรองข้อมูล (เลือก "ทุก Plant" เพื่อแสดงทั้งหมด)<br>
        - Lead Time, Safety, Cover: ปรับจำนวนวันเพื่อคำนวณ ROP, Safety Stock, และแนะนำสั่ง (หน่วยเป็นวัน)<br>
        - ค้นหา: พิมพ์ Material หรือ Description เพื่อค้นหา<br>
        - กดปุ่ม Export เพื่อดาวน์โหลดข้อมูลเป็น CSV</p>
        
        <p><strong>5. ตารางข้อมูล (Table):</strong><br>
        - แสดงรายละเอียดอะไหล่ เช่น Plant, Material, คงเหลือ, มูลค่า, การใช้งาน (6M, 4M, AvgM, 30Day), Mean, Safety, ROP, DOS, แนะนำสั่ง, ABC, Moving, จำนวนส่งคืน, %สะสม<br>
        - กดหัวคอลัมน์เพื่อเรียงข้อมูล (มีไอคอนลูกศร)<br>
        - เลื่อนลงเพื่อดูข้อมูลเพิ่มเติม</p>
        
        <p><strong>6. การนำทางหน้า (Pagination):</strong><br>
        - กดปุ่ม <<, <, >, >> เพื่อเปลี่ยนหน้า<br>
        - แสดงข้อมูลทีละ 25 รายการ</p>
        
        <p><strong>7. การกรองข้อมูล:</strong><br>
        - กดการ์ดสรุปเพื่อกรอง เช่น กด "OverStock" เพื่อแสดงเฉพาะรายการที่สามารถส่งคืนได้<br>
        - การเปลี่ยน Plant จะรีเซ็ตการกรองเป็นค่าเริ่มต้น (แสดงทั้งหมด)<br>
        - การค้นหาจะกรองตามคำที่พิมพ์แบบเรียลไทม์</p>
        
        <p><strong>หมายเหตุ:</strong> ข้อมูลอัปเดตจากแหล่งข้อมูลภายนอก หากมีปัญหาโปรดติดต่อผู้ดูแลระบบ</p>
        <button id="closeHelpBtn">ปิด</button>
    </div>
</div>
<script>
// ฟังก์ชันแปลงตัวเลขเป็น K / M
function formatShortCurrency(n) {
    if (n >= 1e9) return (n / 1e9).toFixed(2) + " พันล้าน";
    if (n >= 1e6) return (n / 1e6).toFixed(2) + " M";
    if (n >= 1e3) return (n / 1e3).toFixed(2) + " K";
    return n.toFixed(2);
}
let sortKey = "CumPercent", sortDir = "asc";
document.addEventListener("DOMContentLoaded", function () {
    const userSheetID = '1eqVoLsZxGguEbRCC5rdI4iMVtQ7CK4T3uXRdx8zE3uw';
    const userSheetName = 'UserPlant';
    const userUrl = `https://opensheet.elk.sh/${userSheetID}/${userSheetName}`;
    const usageUrl = 'https://opensheet.elk.sh/1P8Frv1zvcuO3qt8seU-zMF0FV0TQHyKXLn9GNHVr6kI/MoveAllsum';
    const inventoryUrl = 'https://opensheet.elk.sh/1OtcgbmQdrI3gKJCGiDge6xuOsrT0GPxdKeFPjpvK3Rg/Sheet1';
    const mainsapUrl = 'https://opensheet.elk.sh/1CkfOIe2nDYBLs5aPGkPyZhOeqJkyS7UQ6tuMzxy-mfk/mainsap';
    let allData = [], filteredData = [];
    let mode = "all", abcFilter = "", movingFilter = ""; // ใช้ตัวแปรแยก
    let currentPage = 1;
    const rowsPerPage = 25;
    let users = [];
    let loggedUser = null;
    function toNumber(v) { return parseFloat((v||"0").toString().replace(/,/g,'')) || 0; }
    function formatNumber(n) { return Number(n).toLocaleString('th-TH'); }
    function formatCurrency(n) { return Number(n).toLocaleString('th-TH', {minimumFractionDigits:2, maximumFractionDigits:2}); }
    function calculateKeepQty(r) {
        const avg = r.AvgMonthly;
        if (r.Moving === "Dead" || r.Moving === "Slowly") return 1;
        if (r.Moving === "Slow" && r.ABCValue === "C") return Math.max(1, Math.round(avg * 60));
        if (r.Moving === "Slow" && r.ABCValue === "B") return Math.max(1, Math.round(avg * 60));
        if (r.Moving === "Medium" && r.ABCValue === "C") return Math.max(2, Math.round(avg * 60));
        if (r.Moving === "Slow" && r.ABCValue === "A") return Math.max(3, Math.round(avg * 60));
        if (r.Moving === "Medium" && r.ABCValue === "B") return Math.max(4, Math.round(avg * 60));
        if (r.Moving === "Fast" && r.ABCValue === "C") return Math.max(5, Math.round(avg * 60));
        if (r.Moving === "Medium" && r.ABCValue === "A") return Math.max(6, Math.round(avg * 75));
        if (r.Moving === "Fast" && r.ABCValue === "B") return Math.max(8, Math.round(avg * 90));
        if (r.Moving === "Fast" && r.ABCValue === "A") return Math.max(10, Math.round(avg * 120));
        return Math.max(1, Math.round(avg * 40));
    }
    async function loadUsers() {
        try {
            const res = await fetch(userUrl);
            users = await res.json();
        } catch (e) {
            console.error(e);
            alert("ไม่สามารถโหลดข้อมูลผู้ใช้ได้");
        }
    }
    function checkLogin() {
        const remembered = localStorage.getItem('rememberedUser');
        if (remembered) {
            const user = JSON.parse(remembered);
            loggedUser = user;
            showUserMenu();
            loadData();
            return true;
        }
        const sessionUser = sessionStorage.getItem('loggedUser');
        if (sessionUser) {
            const user = JSON.parse(sessionUser);
            loggedUser = user;
            showUserMenu();
            loadData();
            return true;
        }
        return false;
    }
    function showLogin() {
        document.getElementById('loginModal').style.display = 'flex';
    }
    function hideLogin() {
        document.getElementById('loginModal').style.display = 'none';
    }
    function login() {
        const idUser = document.getElementById('idUserInput').value.trim();
        const password = document.getElementById('passwordInput').value.trim();
        const remember = document.getElementById('rememberMe').checked;
        const user = users.find(u => u.IDUser === idUser);
        if (user && password === idUser.slice(-4)) {
            loggedUser = { IDUser: user.IDUser, Name: user.Name || 'ไม่ระบุ' };
            if (remember) {
                localStorage.setItem('rememberedUser', JSON.stringify(loggedUser));
            } else {
                sessionStorage.setItem('loggedUser', JSON.stringify(loggedUser));
            }
            hideLogin();
            showUserMenu();
            loadData();
        } else {
            document.getElementById('loginError').textContent = 'IDUser หรือ Password ไม่ถูกต้อง';
        }
    }
    function logout() {
        localStorage.removeItem('rememberedUser');
        sessionStorage.removeItem('loggedUser');
        loggedUser = null;
        document.getElementById('userMenu').style.display = 'none';
        document.getElementById('menuBtn').style.display = 'none';
        // ซ่อนเนื้อหาและแสดง login อีกครั้ง
        document.getElementById("mainCardsSection").style.display = "none";
        document.getElementById("summarySection").style.display = "none";
        document.getElementById("controlsSection").style.display = "none";
        document.getElementById("tableSection").style.display = "none";
        document.getElementById("pagination").style.display = "none";
        showLogin();
    }
    function showUserMenu() {
        document.getElementById('menuBtn').style.display = 'block';
        document.getElementById('userID').textContent = `รหัส: ${loggedUser.IDUser}`;
        document.getElementById('userName').textContent = `ชื่อ: ${loggedUser.Name}`;
    }
    document.getElementById('menuBtn').addEventListener('click', () => {
        const menu = document.getElementById('userMenu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    });
    document.getElementById('logoutBtn').addEventListener('click', logout);
    document.getElementById('loginBtn').addEventListener('click', login);
    async function init() {
        await loadUsers();
        if (!checkLogin()) {
            showLogin();
        }
    }
    init();
    async function loadData() {
   const loader = document.getElementById("loader");
const summarySection = document.getElementById("summarySection");
const controlsSection = document.getElementById("controlsSection");
const tableSection = document.getElementById("tableSection");
const paginationSection = document.getElementById("pagination"); // ✅ ถูกต้อง
    // เริ่มโหลด: แสดง loader, ซ่อนเนื้อหา
    loader.style.display = "block";
    summarySection.style.display = "none";
    controlsSection.style.display = "none";
    tableSection.style.display = "none";
    paginationSection.style.display = "block";
    try {
        const [uRes, iRes, mRes] = await Promise.all([fetch(usageUrl), fetch(inventoryUrl), fetch(mainsapUrl)]);
        const usage = await uRes.json();
        const inv = await iRes.json();
        const mainsap = await mRes.json();
        const useMap = new Map();
        const invMap = new Map();
        const mainsapMap = new Map();
        usage.forEach(r => {
            const plant = (r.Plant || '').trim();
            const material = (r.Material || '').trim();
            const key = `${plant}-${material}`;
            useMap.set(key, r);
        });
        inv.forEach(r => {
            const plant = (r.Plant || '').trim();
            const material = (r.Material || '').trim();
            const key = `${plant}-${material}`;
            invMap.set(key, r);
        });
        mainsap.forEach(r => {
            const material = (r.Material || '').trim();
            mainsapMap.set(material, {
                Note: r['หมายเหตุ'] || '',
                MultiplyUnit: toNumber(r['คูณหน่วย']),
                Product: r.Product || ''
            });
        });
        const allKeys = new Set([...useMap.keys(), ...invMap.keys()]);
        allData = Array.from(allKeys).map(key => {
            const [plant, material] = key.split('-');
            const u = useMap.get(key) || {Qtyissu: 0, Qtyissu6m: 0, '30Day': 0};
            const i = invMap.get(key) || {Unrestricted: 0, "Value Unrestricted": 0, "Material description": '', "Base Unit of Measure": ''};
            const main = mainsapMap.get(material) || {Note: '', MultiplyUnit: 1, Product: ''};
            const qty4m = toNumber(u.Qtyissu);
            const qty6m = toNumber(u.Qtyissu6m) || Math.round(qty4m * 1.5);
            const thirtyDay = toNumber(u['30Day']);
            return {
                Plant: plant,
                Material: material,
                Description: i["Material description"] || '',
                Unit: i["Base Unit of Measure"] || '',
                Unrestricted: toNumber(i.Unrestricted),
                Value: toNumber(i["Value Unrestricted"]),
                Qty6Month: qty6m,
                Qty4Month: qty4m,
                ThirtyDay: thirtyDay,
                AvgDailyUse: qty4m / 120 ,
                AvgMonthly: qty4m / 4,
                SafetyStock:0, ROP:0, DOS:0, RecommendedOrder:0, Mean:0,
                ABCValue:"", CumPercent:0, Moving:"", IsNonMoving: qty4m === 0,
                ReturnQty: 0, ReturnValue: 0,
                Note: main.Note,
                MultiplyUnit: main.MultiplyUnit,
                Product: main.Product
            };
        });
        // Fill missing Descriptions
        const descMap = new Map();
        allData.forEach(r => {
            if (r.Description) {
                descMap.set(r.Material, r.Description);
            }
        });
        allData.forEach(r => {
            if (!r.Description && descMap.has(r.Material)) {
                r.Description = descMap.get(r.Material);
            }
        });
        calcABCValue();
        fillPlantDropdown();
        setDefaultAndCalculate();
        // โหลดเสร็จ → แสดงเนื้อหาทั้งหมด
     loader.style.display = "none";
        // เปิดทุกส่วนที่ซ่อนไว้
        document.getElementById("mainCardsSection").style.display = "flex";
        summarySection.style.display = "flex";
        controlsSection.style.display = "flex";
        tableSection.style.display = "block";
        document.getElementById("pagination").style.display = "block";
    } catch(e) {
        loader.style.display = "none";
        summarySection.style.display = "flex"; // หรือแสดง error
        alert("โหลดข้อมูลไม่สำเร็จ");
        console.error(e);
    }
}
    function calcABCValue() {
        const sorted = [...allData].sort((a,b)=>b.Value-a.Value);
        const total = sorted.reduce((s,r)=>s+r.Value,0);
        let cum = 0;
        sorted.forEach(r => {
            cum += r.Value;
            const pct = total ? (cum/total)*100 : 0;
            const orig = allData.find(x=>x.Material===r.Material && x.Plant===r.Plant);
            if(orig){
                orig.CumPercent = pct;
                orig.ABCValue = pct <= 70 ? "A" : pct <= 90 ? "B" : "C";
            }
        });
    }
    // 1. แก้ recalculateStockFields ให้ return ค่ากลับมา
function recalculateStockFields(data, params) {
    data.forEach(r => {
        const d = r.AvgDailyUse || 0;
        const leadTime = params.leadTime || 5;
        const safetyDays = params.safety || 3;
        const coverDays = params.cover || 40;
        const safetyStock = d * safetyDays;
        const rop = (d * leadTime) + safetyStock;
        const dos = d > 0 ? r.Unrestricted / d : 9999;
        r.SafetyStock = Math.round(safetyStock);
        r.ROP = Math.round(rop);
        r.DOS = dos > 9999 ? 9999 : parseFloat(dos.toFixed(1));
       
        // สูตรคำนวณแนะนำสั่งซื้อ (พื้นฐาน)
        let recommend = 0;
        if (r.Unrestricted < rop) {
            const needed = d * coverDays;
            recommend = needed - r.Unrestricted;
            if (recommend < 0) recommend = 0;
        }
        const multiply = r.MultiplyUnit || 1;
        if (multiply > 0) {
            recommend = Math.ceil(recommend / multiply) * multiply;
        }
        r.RecommendedOrder = Math.round(recommend);
       
        // กำหนด Moving จาก AvgMonthly (เฉลี่ย/เดือน)
        const avgMonthly = r.Qty4Month / 4;
        if (avgMonthly === 0) {
            r.Moving = "Dead";
        } else if (avgMonthly < 0.7) {
            r.Moving = "Slowly";
        } else if (avgMonthly < 12) {
            r.Moving = "Slow";
        } else if (avgMonthly < 30) {
            r.Moving = "Medium";
        } else {
            r.Moving = "Fast";
        }
       
        // กำหนด Mean: ค่าสูงสุดระหว่าง ThirtyDay และ AvgMonthly
        if (r.ThirtyDay > r.AvgMonthly) {
            r.Mean = r.ThirtyDay;
        } else {
            r.Mean = r.AvgMonthly;
        }
       
        // ตรวจสอบเงื่อนไขที่ทำให้ไม่สั่งซื้อ
       
        // เงื่อนไข 1: Mean = 0 AND (Moving = Slow OR Moving = Slowly) → ไม่สั่ง
        if (r.Mean === 0 && (r.Moving === "Slow" || r.Moving === "Slowly")) {
            r.RecommendedOrder = 0;
        }
       
        // เงื่อนไข 2: ThirtyDay = 0 AND (Moving = Slow OR Moving = Slowly) → ไม่สั่ง
        if (r.ThirtyDay === 0 && (r.Moving === "Slow" || r.Moving === "Slowly")) {
            r.RecommendedOrder = 0;
        }
       
        // เงื่อนไข 3: ThirtyDay >= Qty4Month AND Moving = Slowly → ไม่สั่ง
        if (r.ThirtyDay >= r.Qty4Month && r.Moving === "Slowly") {
            r.RecommendedOrder = 0;
        }
       
        // ส่งคืน
        const keepQty = calculateKeepQty(r);
        const returnQty = Math.max(0, r.Unrestricted - keepQty);
        const unitPrice = r.Unrestricted > 0 ? r.Value / r.Unrestricted : 0;
        const returnValue = returnQty * unitPrice;
        r.ReturnQty = Math.round(returnQty);
        r.ReturnValue = returnValue;
    });
}
    function fillPlantDropdown() {
        const sel = document.getElementById("plantFilter");
        const plants = [...new Set(allData.map(r=>r.Plant))].filter(Boolean).sort();
        sel.innerHTML = '<option value="">ทุก Plant</option>';
        plants.forEach(p => sel.add(new Option(p,p)));
    }
    function setDefaultAndCalculate() {
        const sel = document.getElementById("plantFilter");
        sel.value = "";
        mode = "all"; abcFilter = ""; movingFilter = "";
        applyFiltersAndRender();
    }
document.getElementById("tableHeader").addEventListener("click", function(e) {
        const col = e.target.closest("th[data-sort]");
        if (!col) return;
        const key = col.getAttribute("data-sort");
        if (sortKey === key) {
            sortDir = sortDir === "asc" ? "desc" : "asc";
        } else {
            sortKey = key;
            sortDir = "desc";
        }
        applyFiltersAndRender();
    });
    // 2. แก้ applyFiltersAndRender ให้รับค่ากลับมา
function applyFiltersAndRender() {
    let data = [...allData];
    const plant = document.getElementById("plantFilter").value;
    if (plant) data = data.filter(r => r.Plant === plant);
    const search = document.getElementById("searchInput").value.toLowerCase();
    if (search) data = data.filter(r => r.Material.toLowerCase().includes(search) || r.Description.toLowerCase().includes(search));
    const params = {
        leadTime: parseInt(document.getElementById("leadTimeDays").value) || 5,
        safety: parseInt(document.getElementById("safetyDays").value) || 3,
        cover: parseInt(document.getElementById("coverDays").value) || 40
    };
    // รับค่ากลับมาจากฟังก์ชัน
    recalculateStockFields(data, params);
    let baseData = [...data];
    // กรอง mode
    if (mode === "onlyOrder") data = data.filter(r => Math.round(r.RecommendedOrder) >= 1);
    else if (mode === "returnable") data = data.filter(r => r.ReturnQty > 0);
    else if (mode === "afterReturn") data = data.map(r => ({...r, Unrestricted: r.Unrestricted - r.ReturnQty, Value: r.Value - r.ReturnValue}));
    if (abcFilter) data = data.filter(r => r.ABCValue === abcFilter);
    if (movingFilter) data = data.filter(r => r.Moving === movingFilter);
    data.sort((a,b) => b.Value - a.Value);
    filteredData = data;
    currentPage = 1;
filteredData.sort((a, b) => {
            let x = a[sortKey] || 0;
            let y = b[sortKey] || 0;
            if (typeof x === "string") x = x.toLowerCase();
            if (typeof y === "string") y = y.toLowerCase();
            return sortDir === "asc" ? (x > y ? 1 : -1) : (x < y ? 1 : -1);
        });
        currentPage = 1;
        renderTable();
        renderPagination();
        updateAllCards(baseData, filteredData);
    }
   // 3. แก้ updateAllCards ให้ไม่ใช้ totalReturnValue อีก (เพราะอัปเดตไปแล้ว)
function updateAllCards(baseData, filteredData) {
    const abc = {A:0,B:0,C:0}, cntABC = {A:0,B:0,C:0};
    const mov = {Fast:0,Medium:0,Slow:0,Slowly:0,Dead:0}, cntMov = {Fast:0,Medium:0,Slow:0,Slowly:0,Dead:0};
    let totalStock = 0, orderItems = 0, orderValue = 0, returnCount = 0, totalReturnValue = 0;
    let total_usage_4m_filtered = 0;
    filteredData.forEach(r => {
        totalStock += r.Value;
        abc[r.ABCValue] += r.Value; cntABC[r.ABCValue]++;
        mov[r.Moving] += r.Value; cntMov[r.Moving]++;
        const qty = Math.round(r.RecommendedOrder);
        if (qty > 0) {
            orderItems++;
            orderValue += qty * (r.Unrestricted > 0 ? r.Value / r.Unrestricted : 0);
        }
        if (r.ReturnQty > 0) returnCount++;
        totalReturnValue += r.ReturnValue;
    });
    let total_usage_4m_base = 0;
    let totalStock_base = 0;
    let totalReturnValue_base = 0;
    baseData.forEach(r => {
        totalStock_base += r.Value;
        totalReturnValue_base += r.ReturnValue;
        if (r.Unrestricted > 0) {
            const unit_price = r.Value / r.Unrestricted;
            total_usage_4m_base += r.Qty4Month * unit_price;
        }
    });
    const monthly_withdrawal = total_usage_4m_base / 4 || 0;
    const daily_usage = total_usage_4m_base / 120 || 0;
    const stock_days = daily_usage > 0 ? Math.round(totalStock_base / daily_usage) : 'N/A';
    const after_stock_days = daily_usage > 0 ? Math.round((totalStock_base - totalReturnValue_base) / daily_usage) : 'N/A';
    // แสดงเป็น K/M
    document.getElementById("totalStockValue").textContent = formatShortCurrency(totalStock);
    document.getElementById("orderTotalValue").textContent = formatShortCurrency(orderValue);
    document.getElementById("sumA").textContent = formatShortCurrency(abc.A);
    document.getElementById("sumB").textContent = formatShortCurrency(abc.B);
    document.getElementById("sumC").textContent = formatShortCurrency(abc.C);
    document.getElementById("valFast").textContent = formatShortCurrency(mov.Fast);
    document.getElementById("valMedium").textContent = formatShortCurrency(mov.Medium);
    document.getElementById("valSlow").textContent = formatShortCurrency(mov.Slow);
    document.getElementById("valSlowly").textContent = formatShortCurrency(mov.Slowly);
    document.getElementById("valDead").textContent = formatShortCurrency(mov.Dead);
    document.getElementById("totalCount").textContent = filteredData.length + " รายการ";
    document.getElementById("orderItemCount").textContent = orderItems;
    document.getElementById("returnItemCount").textContent = returnCount + " รายการ";
    document.getElementById("returnValue").textContent = formatShortCurrency(totalReturnValue);
    document.getElementById("monthlyWithdrawalValue").textContent = formatShortCurrency(monthly_withdrawal);
    document.getElementById("stockDaysValue").textContent = stock_days > 9999 ? 'มาก' : stock_days;
    document.getElementById("afterStockDaysValue").textContent = after_stock_days > 9999 ? 'มาก' : after_stock_days;
    document.getElementById("countA").textContent = cntABC.A + " รายการ";
    document.getElementById("countB").textContent = cntABC.B + " รายการ";
    document.getElementById("countC").textContent = cntABC.C + " รายการ";
    document.getElementById("countFast").textContent = cntMov.Fast + " รายการ";
    document.getElementById("countMedium").textContent = cntMov.Medium + " รายการ";
    document.getElementById("countSlow").textContent = cntMov.Slow + " รายการ";
    document.getElementById("countSlowly").textContent = cntMov.Slowly + " รายการ";
    document.getElementById("countDead").textContent = cntMov.Dead + " รายการ";
}
    function renderTable() {
        const container = document.getElementById("dataList");
        container.innerHTML = "";
        const start = (currentPage-1)*rowsPerPage;
        const end = start + rowsPerPage;
        const pageData = filteredData.slice(start, end);
        if (pageData.length === 0) {
            container.innerHTML = `<tr><td colspan="20" style="text-align:center;padding:50px;color:#95a5a6;font-size:16px;">ไม่มีข้อมูลตามเงื่อนไข</td></tr>`;
            return;
        }
        pageData.forEach(r => {
            const orderQty = Math.round(r.RecommendedOrder);
            const orderClass = orderQty === 0 ? "order-0" :
                              orderQty <= 10 ? "order-1-10" :
                              orderQty <= 50 ? "order-11-50" :
                              orderQty <= 200 ? "order-51-200" : "order-200";
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${r.Plant}</td>
                <td class="material">${r.Material}</td>
                <td class="desc">${r.Description}</td>
                <td>${r.Unit}</td>
                <td>${formatNumber(r.Unrestricted)}</td>
                <td><span class="value">${formatCurrency(r.Value)}</span></td>
                <td>${formatNumber(r.Qty6Month)}</td>
                <td>${formatNumber(r.Qty4Month)}</td>
                <td>${r.AvgMonthly.toLocaleString('th-TH', { minimumFractionDigits: 1, maximumFractionDigits: 1 })}</td>
                <td>${formatNumber(r.ThirtyDay)}</td>
                <td>${r.Mean.toLocaleString('th-TH', { minimumFractionDigits: 1, maximumFractionDigits: 1 })}</td>
                <td>${formatNumber(r.SafetyStock)}</td>
                <td>${formatNumber(r.ROP)}</td>
                <td>${r.DOS>9999?'มาก':r.DOS.toFixed(1)}</td>
                <td><span class="${orderClass} order">${formatNumber(orderQty)}</span></td>
                <td>${r.Note}</td>
                <td>${formatNumber(r.MultiplyUnit)}</td>
                <td>${r.Product}</td>
                <td><strong>${r.ABCValue}</strong></td>
                <td><span class="moving-${r.Moving.toLowerCase()}">${r.Moving}</span></td>
                <td><span class="return-qty">${formatNumber(r.ReturnQty)}</span></td>
                <td>${r.CumPercent.toFixed(1)}%</td>
            `;
            container.appendChild(row);
        });
    }
    function renderPagination() {
        const totalPages = Math.max(1, Math.ceil(filteredData.length / rowsPerPage));
        const p = document.getElementById("pagination");
        p.innerHTML = "";
        const createBtn = (text, page, disabled = false) => {
            const btn = document.createElement("button");
            btn.className = "page-btn";
            if (page === currentPage) btn.classList.add("active");
            btn.textContent = text;
            btn.disabled = disabled;
            if (!disabled) btn.onclick = () => { currentPage = page; renderTable(); renderPagination(); };
            return btn;
        };
        p.appendChild(createBtn("<<", 1, currentPage === 1));
        p.appendChild(createBtn("<", currentPage - 1, currentPage === 1));
        p.appendChild(createBtn(currentPage, currentPage, true));
        p.appendChild(createBtn(">", currentPage + 1, currentPage === totalPages));
        p.appendChild(createBtn(">>", totalPages, currentPage === totalPages));
    }
    function exportToCSV() {
        const headers = ["Plant","Material","รายการอะไหล่","หน่วย","คงเหลือ","มูลค่า","ใช้ 6 เดือน","ใช้ 4 เดือน","เฉลี่ย/ด.","30Day","Mean","Safety","ROP","DOS","แนะนำสั่งซื้อ","หมายเหตุ","คูณหน่วย","Product","ABC","Moving","ส่งคืนได้ (ชิ้น)","% สะสม"];
        let csv = "\uFEFF" + headers.join(",") + "\n";
        filteredData.forEach(r => {
            const row = [
                r.Plant, r.Material, r.Description.replace(/"/g, '""'), r.Unit,
                r.Unrestricted, r.Value, r.Qty6Month, r.Qty4Month,
                r.AvgDailyUse.toFixed(1), r.ThirtyDay, r.Mean.toFixed(1), Math.round(r.SafetyStock), Math.round(r.ROP),
                r.DOS > 9999 ? "มาก" : r.DOS.toFixed(1), Math.round(r.RecommendedOrder),
                r.Note, r.MultiplyUnit, r.Product,
                r.ABCValue, r.Moving, r.ReturnQty, r.CumPercent.toFixed(2)
            ];
            csv += row.map(v => `"${v}"`).join(",") + "\n";
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `ABC_Analysis_${new Date().toISOString().slice(0,10)}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    }
    // คลิก Card หลัก - รีเซ็ต ABC/Moving filter
    document.getElementById("cardTotalStock").onclick = () => { mode = "all"; abcFilter = ""; movingFilter = ""; applyFiltersAndRender(); };
    document.getElementById("cardOrderItems").onclick = () => { mode = "onlyOrder"; abcFilter = ""; movingFilter = ""; applyFiltersAndRender(); };
    document.getElementById("cardReturnValue").onclick = () => { mode = "returnable"; abcFilter = ""; movingFilter = ""; applyFiltersAndRender(); };
    // คลิก Card ABC / Moving - กรองต่อเนื่อง (คง Plant + mode เดิม)
    document.getElementById("abcA").onclick = () => { abcFilter = "A"; movingFilter = ""; applyFiltersAndRender(); };
    document.getElementById("abcB").onclick = () => { abcFilter = "B"; movingFilter = ""; applyFiltersAndRender(); };
    document.getElementById("abcC").onclick = () => { abcFilter = "C"; movingFilter = ""; applyFiltersAndRender(); };
    document.getElementById("cardFast").onclick = () => { movingFilter = "Fast"; abcFilter = ""; applyFiltersAndRender(); };
    document.getElementById("cardMedium").onclick = () => { movingFilter = "Medium"; abcFilter = ""; applyFiltersAndRender(); };
    document.getElementById("cardSlow").onclick = () => { movingFilter = "Slow"; abcFilter = ""; applyFiltersAndRender(); };
    document.getElementById("cardSlowly").onclick = () => { movingFilter = "Slowly"; abcFilter = ""; applyFiltersAndRender(); };
    document.getElementById("cardDead").onclick = () => { movingFilter = "Dead"; abcFilter = ""; applyFiltersAndRender(); };
    document.getElementById("plantFilter").addEventListener("change", () => { mode = "all"; abcFilter = ""; movingFilter = ""; applyFiltersAndRender(); });
    ["leadTimeDays","safetyDays","coverDays","searchInput"].forEach(id => {
        document.getElementById(id).addEventListener("input", applyFiltersAndRender);
    });
    document.getElementById("exportBtn").onclick = exportToCSV;
    // Help Modal Logic
    document.getElementById('helpBtn').addEventListener('click', () => {
        document.getElementById('helpModal').style.display = 'flex';
    });
    document.getElementById('closeHelpBtn').addEventListener('click', () => {
        document.getElementById('helpModal').style.display = 'none';
    });
});
</script>
</body>
</html>
